<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∏ Badminton Tournament Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 32px;
            margin: 10px 0;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .card-header h2 {
            font-size: 20px;
            color: #1F2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-content {
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background: #3B82F6;
            color: white;
            width: 100%;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
            width: 100%;
        }
        
        .btn-purple {
            background: #8B5CF6;
            color: white;
        }
        
        .btn-gray {
            background: #6B7280;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: #FEE2E2;
            color: #991B1B;
            padding: 6px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .team-input {
            margin-bottom: 16px;
        }
        
        .error {
            margin-top: 16px;
            padding: 12px;
            background: #FEE2E2;
            border: 1px solid #EF4444;
            border-radius: 8px;
            color: #991B1B;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead tr {
            background: #F3F4F6;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
        }
        
        th {
            font-weight: 600;
            color: #374151;
        }
        
        tbody tr {
            border-bottom: 1px solid #E5E7EB;
        }
        
        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            margin-bottom: 10px;
        }
        
        .remaining-box {
            margin-top: 16px;
            padding: 12px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        
        .flex-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .text-center {
            text-align: center;
        }
        
        .no-matches {
            color: #6B7280;
            text-align: center;
            padding: 20px;
        }
        
        .match-result {
            background: #F0FDF4;
            border: 2px solid #10B981;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .match-result.final {
            background: #FEF3C7;
            border-color: #F59E0B;
        }

        .match-result.third-place {
            background: #FCE7F3;
            border-color: #EC4899;
        }

        .playoff-match {
            background: #F9FAFB;
            border: 2px solid #E5E7EB;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .playoff-match h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #374151;
        }

        .match-vs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 12px 0;
            font-size: 18px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 48px;">üè∏</div>
            <h1>Badminton Tournament Tracker</h1>
            <button id="resetBtn" class="btn-gray hidden" onclick="resetTournament()">Reset Tournament</button>
        </div>

        <!-- Team Setup Card -->
        <div class="card">
            <div class="card-header" id="setupHeader">
                <h2>
                    <span>üë•</span>
                    <span id="setupTitle">Team Setup</span>
                </h2>
                <span id="chevron">‚ñº</span>
            </div>
            <div class="card-content" id="setupContent">
                <div id="numTeamsSection">
                    <label>How many teams are playing?</label>
                    <input type="number" id="numTeams" min="2" max="8" placeholder="Enter number (2-8)">
                    <button class="btn-primary" onclick="createTeamInputs()">Continue</button>
                </div>
                <div id="teamInputsSection" class="hidden"></div>
                <div id="setupError" class="error hidden"></div>
            </div>
        </div>

        <!-- Tournament Section -->
        <div id="tournamentSection" class="hidden">
            <div class="grid-2">
                <!-- Add Match Card -->
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Add Match Result</h2>
                    <label>Team 1</label>
                    <select id="team1Select">
                        <option value="">Select team</option>
                    </select>
                    <label>Score 1</label>
                    <input type="number" id="score1" min="0" placeholder="0">
                    <label>Team 2</label>
                    <select id="team2Select">
                        <option value="">Select team</option>
                    </select>
                    <label>Score 2</label>
                    <input type="number" id="score2" min="0" placeholder="0">
                    <button class="btn-primary" onclick="addMatch()">Add Match Result</button>
                    <div id="matchError" class="error hidden"></div>
                </div>

                <!-- Leaderboard Card -->
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Leaderboard</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th class="text-center">Played</th>
                                    <th class="text-center">Wins</th>
                                    <th class="text-center">Losses</th>
                                    <th class="text-center">+/-</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Semifinal Matches Card -->
            <div class="card">
                <h2 style="margin-bottom: 16px;">üèÜ Playoff Matches</h2>
                <div id="semifinalContent"></div>
            </div>

            <!-- Check Remaining Matches Card -->
            <div class="card">
                <h2 style="margin-bottom: 16px;">Check Remaining Matches</h2>
                <div class="flex-row">
                    <div class="flex-1">
                        <label>Select Team</label>
                        <select id="remainingTeamSelect">
                            <option value="">Choose a team</option>
                        </select>
                    </div>
                    <button class="btn-purple" onclick="showRemainingMatches()">Show Remaining</button>
                </div>
                <div id="remainingMatchesBox" class="hidden"></div>
            </div>

            <!-- Completed Matches Card -->
            <div class="card" id="completedMatchesCard">
                <h2 style="margin-bottom: 16px;">Completed Matches (<span id="matchCount">0</span>)</h2>
                <div id="matchesList"></div>
            </div>

            <!-- Tournament Summary Card -->
            <div id="tournamentSummarySection" class="hidden"></div>
        </div>
    </div>

    <script>
        const TEAM_COLORS = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];
        const COLOR_NAMES = ['Red', 'Blue', 'Green', 'Orange', 'Purple', 'Pink', 'Teal', 'Coral'];
        
        let teams = [];
        let matches = [];
        let setupComplete = false;
        let setupMinimized = false;
        let semifinal1 = null;
        let semifinal2 = null;
        let finalMatch = null;
        let thirdPlaceMatch = null;

        // Load data on page load
        window.onload = function() {
            const savedTeams = JSON.parse(localStorage.getItem('teams') || '[]');
            const savedMatches = JSON.parse(localStorage.getItem('matches') || '[]');
            const savedSemifinal1 = JSON.parse(localStorage.getItem('semifinal1') || 'null');
            const savedSemifinal2 = JSON.parse(localStorage.getItem('semifinal2') || 'null');
            const savedFinal = JSON.parse(localStorage.getItem('finalMatch') || 'null');
            const savedThirdPlace = JSON.parse(localStorage.getItem('thirdPlaceMatch') || 'null');
            
            if (savedTeams.length > 0) {
                teams = savedTeams;
                matches = savedMatches;
                semifinal1 = savedSemifinal1;
                semifinal2 = savedSemifinal2;
                finalMatch = savedFinal;
                thirdPlaceMatch = savedThirdPlace;
                setupComplete = true;
                setupMinimized = true;
                showTournament();
            }
        };

        function createTeamInputs() {
            const num = parseInt(document.getElementById('numTeams').value);
            if (num < 2 || num > 8) {
                showError('setupError', 'Please enter between 2 and 8 teams');
                return;
            }

            teams = Array.from({ length: num }, (_, i) => ({
                id: i,
                color: TEAM_COLORS[i],
                colorName: COLOR_NAMES[i],
                playerName: ''
            }));

            document.getElementById('numTeamsSection').classList.add('hidden');
            const section = document.getElementById('teamInputsSection');
            section.classList.remove('hidden');
            
            let html = '<h3 style="font-size: 16px; margin-bottom: 16px; color: #374151;">Enter Player Names</h3>';
            teams.forEach(team => {
                html += `
                    <div class="team-input">
                        <label style="color: ${team.color};">Team ${team.colorName}</label>
                        <input type="text" maxlength="16" id="player_${team.id}" 
                               placeholder="Enter player name (max 16 chars)" 
                               style="border-color: ${team.color};">
                    </div>
                `;
            });
            html += '<button class="btn-success" onclick="saveTeams()">Save & Start Tournament</button>';
            section.innerHTML = html;
            hideError('setupError');
        }

        function saveTeams() {
            let allFilled = true;
            teams.forEach(team => {
                const input = document.getElementById(`player_${team.id}`);
                team.playerName = input.value.trim();
                if (!team.playerName) allFilled = false;
            });

            if (!allFilled) {
                showError('setupError', 'Please fill in all player names');
                return;
            }

            localStorage.setItem('teams', JSON.stringify(teams));
            localStorage.setItem('matches', JSON.stringify([]));
            matches = [];
            setupComplete = true;
            setupMinimized = true;
            showTournament();
        }

        function showTournament() {
            document.getElementById('setupTitle').textContent = 'Team Setup (Complete)';
            document.getElementById('setupContent').classList.add('hidden');
            document.getElementById('chevron').textContent = '‚ñº';
            document.getElementById('tournamentSection').classList.remove('hidden');
            document.getElementById('resetBtn').classList.remove('hidden');
            
            // Setup header click handler
            document.getElementById('setupHeader').style.cursor = 'pointer';
            document.getElementById('setupHeader').onclick = toggleSetup;
            
            populateDropdowns();
            updateLeaderboard();
            updateMatchesList();
            updatePlayoffSection();
            updateTournamentSummary();
        }

        function toggleSetup() {
            if (!setupComplete) return;
            setupMinimized = !setupMinimized;
            const content = document.getElementById('setupContent');
            const chevron = document.getElementById('chevron');
            
            if (setupMinimized) {
                content.classList.add('hidden');
                chevron.textContent = '‚ñº';
            } else {
                content.classList.remove('hidden');
                chevron.textContent = '‚ñ≤';
            }
        }

        function populateDropdowns() {
            const selects = ['team1Select', 'team2Select', 'remainingTeamSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const options = teams.map(t => 
                    `<option value="${t.colorName}">${t.colorName} - ${t.playerName}</option>`
                ).join('');
                select.innerHTML = `<option value="">${selectId === 'remainingTeamSelect' ? 'Choose a team' : 'Select team'}</option>${options}`;
            });
        }

        function addMatch() {
            const team1 = document.getElementById('team1Select').value;
            const team2 = document.getElementById('team2Select').value;
            const score1 = parseInt(document.getElementById('score1').value);
            const score2 = parseInt(document.getElementById('score2').value);

            if (!team1 || !team2) {
                showError('matchError', 'Please select both teams');
                return;
            }

            if (team1 === team2) {
                showError('matchError', 'Teams must be different');
                return;
            }

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showError('matchError', 'Please enter valid scores');
                return;
            }

            const matchExists = matches.some(m => 
                (m.team1 === team1 && m.team2 === team2) ||
                (m.team1 === team2 && m.team2 === team1)
            );

            if (matchExists) {
                showError('matchError', 'Match between these teams already recorded');
                return;
            }

            matches.push({
                id: Date.now(),
                team1,
                team2,
                score1,
                score2
            });

            localStorage.setItem('matches', JSON.stringify(matches));
            
            document.getElementById('team1Select').value = '';
            document.getElementById('team2Select').value = '';
            document.getElementById('score1').value = '';
            document.getElementById('score2').value = '';
            
            hideError('matchError');
            updateLeaderboard();
            updateMatchesList();
            updatePlayoffSection();
            updateTournamentSummary();
        }

        function cancelMatch(matchId) {
            matches = matches.filter(m => m.id !== matchId);
            localStorage.setItem('matches', JSON.stringify(matches));
            updateLeaderboard();
            updateMatchesList();
        }

        function updateLeaderboard() {
            const stats = teams.map(team => ({
                ...team,
                played: 0,
                wins: 0,
                losses: 0,
                pointsFor: 0,
                pointsAgainst: 0
            }));

            matches.forEach(match => {
                const team1Stats = stats.find(s => s.colorName === match.team1);
                const team2Stats = stats.find(s => s.colorName === match.team2);

                if (team1Stats && team2Stats) {
                    team1Stats.played++;
                    team2Stats.played++;
                    team1Stats.pointsFor += match.score1;
                    team1Stats.pointsAgainst += match.score2;
                    team2Stats.pointsFor += match.score2;
                    team2Stats.pointsAgainst += match.score1;

                    if (match.score1 > match.score2) {
                        team1Stats.wins++;
                        team2Stats.losses++;
                    } else {
                        team2Stats.wins++;
                        team1Stats.losses++;
                    }
                }
            });

            const leaderboard = stats
                .map(s => ({
                    ...s,
                    pointDiff: s.pointsFor - s.pointsAgainst
                }))
                .sort((a, b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    return b.pointDiff - a.pointDiff;
                });

            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = leaderboard.map(team => `
                <tr>
                    <td>
                        <span style="color: ${team.color}; font-weight: 600;">${team.colorName}</span>
                        <span style="color: #6B7280; font-size: 12px; margin-left: 4px;">(${team.playerName})</span>
                    </td>
                    <td class="text-center">${team.played}</td>
                    <td class="text-center" style="font-weight: 600; color: #10B981;">${team.wins}</td>
                    <td class="text-center" style="font-weight: 600; color: #EF4444;">${team.losses}</td>
                    <td class="text-center" style="font-weight: 600; color: ${team.pointDiff >= 0 ? '#10B981' : '#EF4444'};">
                        ${team.pointDiff >= 0 ? '+' : ''}${team.pointDiff}
                    </td>
                </tr>
            `).join('');
        }

        function updateMatchesList() {
            document.getElementById('matchCount').textContent = matches.length;
            const list = document.getElementById('matchesList');
            
            if (matches.length === 0) {
                list.innerHTML = '<div class="no-matches">No matches recorded yet</div>';
                return;
            }

            list.innerHTML = matches.map(match => {
                const t1 = teams.find(t => t.colorName === match.team1);
                const t2 = teams.find(t => t.colorName === match.team2);
                return `
                    <div class="match-item">
                        <div style="font-size: 14px;">
                            <span style="color: ${t1?.color}; font-weight: 600;">${match.team1}</span>
                            <span style="margin: 0 8px; font-weight: 600;">(${match.score1})</span>
                            <span style="color: #6B7280;">vs</span>
                            <span style="margin: 0 8px; font-weight: 600;">(${match.score2})</span>
                            <span style="color: ${t2?.color}; font-weight: 600;">${match.team2}</span>
                        </div>
                        <button class="btn-danger" onclick="cancelMatch(${match.id})" title="Cancel match">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function showRemainingMatches() {
            const selectedTeam = document.getElementById('remainingTeamSelect').value;
            if (!selectedTeam) {
                alert('Please select a team');
                return;
            }

            const playedAgainst = matches
                .filter(m => m.team1 === selectedTeam || m.team2 === selectedTeam)
                .map(m => m.team1 === selectedTeam ? m.team2 : m.team1);

            const remaining = teams
                .filter(t => t.colorName !== selectedTeam && !playedAgainst.includes(t.colorName));

            const box = document.getElementById('remainingMatchesBox');
            box.classList.remove('hidden');

            if (remaining.length === 0) {
                box.innerHTML = `
                    <div class="remaining-box">
                        <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            ${selectedTeam} needs to play against:
                        </h3>
                        <p style="color: #10B981; font-weight: 600; font-size: 14px;">‚úì All matches completed!</p>
                    </div>
                `;
            } else {
                const list = remaining.map(team => 
                    `<li style="color: ${team.color}; font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                        ${team.colorName} (${team.playerName})
                    </li>`
                ).join('');
                
                box.innerHTML = `
                    <div class="remaining-box">
                        <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            ${selectedTeam} needs to play against:
                        </h3>
                        <ul style="margin: 0; padding-left: 20px;">${list}</ul>
                    </div>
                `;
            }
        }

        function resetTournament() {
            if (confirm('Are you sure you want to reset and start over?')) {
                localStorage.removeItem('teams');
                localStorage.removeItem('matches');
                localStorage.removeItem('semifinal1');
                localStorage.removeItem('semifinal2');
                localStorage.removeItem('finalMatch');
                localStorage.removeItem('thirdPlaceMatch');
                location.reload();
            }
        }

        function updatePlayoffSection() {
            const content = document.getElementById('semifinalContent');
            
            if (teams.length < 4) {
                content.innerHTML = '<p class="no-matches">Need at least 4 teams for playoffs</p>';
                return;
            }

            const leaderboard = getLeaderboardData();
            const top4 = leaderboard.slice(0, 4);
            
            // Check if there's a clear top 4 (no ties at position 4)
            const hasClearTop4 = leaderboard.length === 4 || 
                (leaderboard.length > 4 && 
                 (top4[3].wins !== leaderboard[4].wins || 
                  (top4[3].wins === leaderboard[4].wins && top4[3].pointDiff !== leaderboard[4].pointDiff)));

            let html = '';

            // Show Final Match if exists
            if (finalMatch) {
                html += renderMatchResult(finalMatch, 'final', 'üèÜ Final Match');
            }

            // Show Third Place Match if exists
            if (thirdPlaceMatch) {
                html += renderMatchResult(thirdPlaceMatch, 'third-place', 'ü•â Third Place Match');
            }

            // Semifinal 1
            if (semifinal1) {
                html += renderMatchResult(semifinal1, '', '‚öîÔ∏è Semifinal Match 1');
            } else if (hasClearTop4) {
                html += renderSemifinalInput('semifinal1', 'Semifinal Match 1', top4[0], top4[3]);
            } else {
                html += renderSemifinalInputManual('semifinal1', 'Semifinal Match 1');
            }

            // Semifinal 2
            if (semifinal2) {
                html += renderMatchResult(semifinal2, '', '‚öîÔ∏è Semifinal Match 2');
            } else if (hasClearTop4) {
                html += renderSemifinalInput('semifinal2', 'Semifinal Match 2', top4[1], top4[2]);
            } else {
                html += renderSemifinalInputManual('semifinal2', 'Semifinal Match 2');
            }

            // Show final input if both semifinals are complete
            if (semifinal1 && semifinal2 && !finalMatch) {
                const sf1Winner = semifinal1.score1 > semifinal1.score2 ? semifinal1.team1 : semifinal1.team2;
                const sf2Winner = semifinal2.score1 > semifinal2.score2 ? semifinal2.team1 : semifinal2.team2;
                const sf1Loser = semifinal1.score1 > semifinal1.score2 ? semifinal1.team2 : semifinal1.team1;
                const sf2Loser = semifinal2.score1 > semifinal2.score2 ? semifinal2.team2 : semifinal2.team1;
                
                html += renderFinalInput(sf1Winner, sf2Winner, sf1Loser, sf2Loser);
            }

            content.innerHTML = html || '<p class="no-matches">Complete round robin matches to start playoffs</p>';
        }

        function renderMatchResult(match, extraClass, title) {
            const t1 = teams.find(t => t.colorName === match.team1);
            const t2 = teams.find(t => t.colorName === match.team2);
            const winner = match.score1 > match.score2 ? match.team1 : match.team2;
            const winnerColor = match.score1 > match.score2 ? t1?.color : t2?.color;
            
            return `
                <div class="match-result ${extraClass}">
                    <h3 style="margin-bottom: 12px; font-size: 18px;">${title}</h3>
                    <div class="match-vs">
                        <span style="color: ${t1?.color}; ${match.score1 > match.score2 ? 'font-size: 22px;' : ''}">${match.team1}</span>
                        <span style="background: white; padding: 4px 12px; border-radius: 6px;">${match.score1}</span>
                        <span style="color: #6B7280;">vs</span>
                        <span style="background: white; padding: 4px 12px; border-radius: 6px;">${match.score2}</span>
                        <span style="color: ${t2?.color}; ${match.score2 > match.score1 ? 'font-size: 22px;' : ''}">${match.team2}</span>
                    </div>
                    <p style="text-align: center; margin-top: 8px; color: ${winnerColor}; font-weight: 600;">
                        üèÜ Winner: ${winner}
                    </p>
                </div>
            `;
        }

        function renderSemifinalInput(matchId, title, team1, team2) {
            return `
                <div class="playoff-match">
                    <h3>‚öîÔ∏è ${title}</h3>
                    <div class="match-vs">
                        <span style="color: ${team1.color};">${team1.colorName}</span>
                        <span style="color: #6B7280;">vs</span>
                        <span style="color: ${team2.color};">${team2.colorName}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score ${team1.colorName}</label>
                            <input type="number" id="${matchId}_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score ${team2.colorName}</label>
                            <input type="number" id="${matchId}_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top: 12px;" onclick="saveSemifinal('${matchId}', '${team1.colorName}', '${team2.colorName}')">
                        Save Result
                    </button>
                </div>
            `;
        }

        function renderSemifinalInputManual(matchId, title) {
            return `
                <div class="playoff-match">
                    <h3>‚öîÔ∏è ${title}</h3>
                    <p style="color: #6B7280; font-size: 14px; margin-bottom: 12px;">
                        Tied positions detected. Please select teams manually.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label>Team 1</label>
                            <select id="${matchId}_team1" style="margin-bottom: 0;">
                                <option value="">Select team</option>
                                ${teams.map(t => `<option value="${t.colorName}">${t.colorName} - ${t.playerName}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label>Team 2</label>
                            <select id="${matchId}_team2" style="margin-bottom: 0;">
                                <option value="">Select team</option>
                                ${teams.map(t => `<option value="${t.colorName}">${t.colorName} - ${t.playerName}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score 1</label>
                            <input type="number" id="${matchId}_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score 2</label>
                            <input type="number" id="${matchId}_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top: 12px;" onclick="saveSemifinalManual('${matchId}')">
                        Save Result
                    </button>
                </div>
            `;
        }

        function renderFinalInput(winner1, winner2, loser1, loser2) {
            return `
                <div class="playoff-match" style="border-color: #F59E0B;">
                    <h3>üèÜ Final Match</h3>
                    <div class="match-vs">
                        <span style="color: ${teams.find(t => t.colorName === winner1)?.color};">${winner1}</span>
                        <span style="color: #6B7280;">vs</span>
                        <span style="color: ${teams.find(t => t.colorName === winner2)?.color};">${winner2}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score ${winner1}</label>
                            <input type="number" id="final_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score ${winner2}</label>
                            <input type="number" id="final_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top: 12px; background: #F59E0B;" onclick="saveFinal('${winner1}', '${winner2}')">
                        Save Final Result
                    </button>
                </div>
                <div class="playoff-match" style="border-color: #EC4899; margin-top: 16px;">
                    <h3>ü•â Third Place Match</h3>
                    <div class="match-vs">
                        <span style="color: ${teams.find(t => t.colorName === loser1)?.color};">${loser1}</span>
                        <span style="color: #6B7280;">vs</span>
                        <span style="color: ${teams.find(t => t.colorName === loser2)?.color};">${loser2}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score ${loser1}</label>
                            <input type="number" id="third_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score ${loser2}</label>
                            <input type="number" id="third_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top: 12px; background: #EC4899;" onclick="saveThirdPlace('${loser1}', '${loser2}')">
                        Save Third Place Result
                    </button>
                </div>
            `;
        }

        function saveSemifinal(matchId, team1, team2) {
            const score1 = parseInt(document.getElementById(`${matchId}_score1`).value);
            const score2 = parseInt(document.getElementById(`${matchId}_score2`).value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                alert('Please enter valid scores');
                return;
            }

            if (score1 === score2) {
                alert('Scores cannot be tied in playoff matches');
                return;
            }

            const match = {
                team1,
                team2,
                score1,
                score2
            };

            if (matchId === 'semifinal1') {
                semifinal1 = match;
                localStorage.setItem('semifinal1', JSON.stringify(match));
            } else {
                semifinal2 = match;
                localStorage.setItem('semifinal2', JSON.stringify(match));
            }

            updatePlayoffSection();
        }

        function saveSemifinalManual(matchId) {
            const team1 = document.getElementById(`${matchId}_team1`).value;
            const team2 = document.getElementById(`${matchId}_team2`).value;
            const score1 = parseInt(document.getElementById(`${matchId}_score1`).value);
            const score2 = parseInt(document.getElementById(`${matchId}_score2`).value);

            if (!team1 || !team2) {
                alert('Please select both teams');
                return;
            }

            if (team1 === team2) {
                alert('Teams must be different');
                return;
            }

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                alert('Please enter valid scores');
                return;
            }

            if (score1 === score2) {
                alert('Scores cannot be tied in playoff matches');
                return;
            }

            const match = {
                team1,
                team2,
                score1,
                score2
            };

            if (matchId === 'semifinal1') {
                semifinal1 = match;
                localStorage.setItem('semifinal1', JSON.stringify(match));
            } else {
                semifinal2 = match;
                localStorage.setItem('semifinal2', JSON.stringify(match));
            }

            updatePlayoffSection();
        }

        function saveFinal(team1, team2) {
            const score1 = parseInt(document.getElementById('final_score1').value);
            const score2 = parseInt(document.getElementById('final_score2').value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                alert('Please enter valid scores');
                return;
            }

            if (score1 === score2) {
                alert('Scores cannot be tied in playoff matches');
                return;
            }

            finalMatch = {
                team1,
                team2,
                score1,
                score2
            };

            localStorage.setItem('finalMatch', JSON.stringify(finalMatch));
            updatePlayoffSection();
            updateTournamentSummary();
        }

        function saveThirdPlace(team1, team2) {
            const score1 = parseInt(document.getElementById('third_score1').value);
            const score2 = parseInt(document.getElementById('third_score2').value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                alert('Please enter valid scores');
                return;
            }

            if (score1 === score2) {
                alert('Scores cannot be tied in playoff matches');
                return;
            }

            thirdPlaceMatch = {
                team1,
                team2,
                score1,
                score2
            };

            localStorage.setItem('thirdPlaceMatch', JSON.stringify(thirdPlaceMatch));
            updatePlayoffSection();
            updateTournamentSummary();
        }

        function getLeaderboardData() {
            const stats = teams.map(team => ({
                ...team,
                played: 0,
                wins: 0,
                losses: 0,
                pointsFor: 0,
                pointsAgainst: 0
            }));

            matches.forEach(match => {
                const team1Stats = stats.find(s => s.colorName === match.team1);
                const team2Stats = stats.find(s => s.colorName === match.team2);

                if (team1Stats && team2Stats) {
                    team1Stats.played++;
                    team2Stats.played++;
                    team1Stats.pointsFor += match.score1;
                    team1Stats.pointsAgainst += match.score2;
                    team2Stats.pointsFor += match.score2;
                    team2Stats.pointsAgainst += match.score1;

                    if (match.score1 > match.score2) {
                        team1Stats.wins++;
                        team2Stats.losses++;
                    } else {
                        team2Stats.wins++;
                        team1Stats.losses++;
                    }
                }
            });

            return stats
                .map(s => ({
                    ...s,
                    pointDiff: s.pointsFor - s.pointsAgainst
                }))
                .sort((a, b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    return b.pointDiff - a.pointDiff;
                });
        }

        function updateTournamentSummary() {
            const summarySection = document.getElementById('tournamentSummarySection');
            
            // Check if tournament is complete (final and third place matches done)
            if (!finalMatch || !thirdPlaceMatch) {
                summarySection.classList.add('hidden');
                return;
            }

            // Get winners
            const champion = finalMatch.score1 > finalMatch.score2 ? finalMatch.team1 : finalMatch.team2;
            const runnerUp = finalMatch.score1 > finalMatch.score2 ? finalMatch.team2 : finalMatch.team1;
            const thirdPlace = thirdPlaceMatch.score1 > thirdPlaceMatch.score2 ? thirdPlaceMatch.team1 : thirdPlaceMatch.team2;

            const championTeam = teams.find(t => t.colorName === champion);
            const runnerUpTeam = teams.find(t => t.colorName === runnerUp);
            const thirdPlaceTeam = teams.find(t => t.colorName === thirdPlace);

            // Calculate statistics
            const leaderboard = getLeaderboardData();
            
            // Most wins
            const mostWins = leaderboard.reduce((max, team) => team.wins > max.wins ? team : max, leaderboard[0]);
            
            // Most points scored
            const mostPoints = leaderboard.reduce((max, team) => team.pointsFor > max.pointsFor ? team : max, leaderboard[0]);
            
            // Best point differential
            const bestDiff = leaderboard.reduce((max, team) => team.pointDiff > max.pointDiff ? team : max, leaderboard[0]);
            
            // Most matches played
            const mostPlayed = leaderboard.reduce((max, team) => team.played > max.played ? team : max, leaderboard[0]);
            
            // Total matches
            const totalMatches = matches.length + 3; // Round robin + 2 semifinals + final + third place
            
            // Total points scored
            const totalPoints = matches.reduce((sum, m) => sum + m.score1 + m.score2, 0) +
                               (semifinal1 ? semifinal1.score1 + semifinal1.score2 : 0) +
                               (semifinal2 ? semifinal2.score1 + semifinal2.score2 : 0) +
                               finalMatch.score1 + finalMatch.score2 +
                               thirdPlaceMatch.score1 + thirdPlaceMatch.score2;
            
            // Average points per match
            const avgPoints = (totalPoints / totalMatches).toFixed(1);

            // Find highest scoring match
            const allMatches = [
                ...matches,
                ...(semifinal1 ? [semifinal1] : []),
                ...(semifinal2 ? [semifinal2] : []),
                finalMatch,
                thirdPlaceMatch
            ];
            const highestScoringMatch = allMatches.reduce((max, m) => {
                const total = m.score1 + m.score2;
                const maxTotal = max.score1 + max.score2;
                return total > maxTotal ? m : max;
            }, allMatches[0]);

            summarySection.classList.remove('hidden');
            summarySection.innerHTML = `
                <div class="tournament-summary">
                    <h2 style="text-align: center; font-size: 32px; margin-bottom: 10px;">üèÜ Tournament Complete! üèÜ</h2>
                    <p style="text-align: center; opacity: 0.9; margin-bottom: 30px;">Congratulations to all participants!</p>
                    
                    <div class="trophy-podium">
                        <div class="podium-place first">
                            <div style="font-size: 48px; margin-bottom: 10px;">ü•á</div>
                            <div style="font-size: 12px; font-weight: 600; opacity: 0.8; margin-bottom: 5px;">CHAMPION</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${championTeam?.color};">${champion}</div>
                            <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">${championTeam?.playerName}</div>
                        </div>
                        
                        <div class="podium-place second">
                            <div style="font-size: 40px; margin-bottom: 10px;">ü•à</div>
                            <div style="font-size: 12px; font-weight: 600; opacity: 0.8; margin-bottom: 5px;">RUNNER-UP</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${runnerUpTeam?.color};">${runnerUp}</div>
                            <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">${runnerUpTeam?.playerName}</div>
                        </div>
                        
                        <div class="podium-place third">
                            <div style="font-size: 36px; margin-bottom: 10px;">ü•â</div>
                            <div style="font-size: 12px; font-weight: 600; opacity: 0.8; margin-bottom: 5px;">THIRD PLACE</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${thirdPlaceTeam?.color};">${thirdPlace}</div>
                            <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">${thirdPlaceTeam?.playerName}</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 20px; text-align: center;">üìä Tournament Statistics</h3>
                    
                    <div class="metric-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Matches</div>
                            <div class="metric-value">${totalMatches}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Total Points Scored</div>
                            <div class="metric-value">${totalPoints}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Avg Points/Match</div>
                            <div class="metric-value">${avgPoints}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Most League Wins</div>
                            <div class="metric-value" style="font-size: 18px; color: ${mostWins.color};">
                                ${mostWins.colorName} (${mostWins.wins})
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Most League Points</div>
                            <div class="metric-value" style="font-size: 18px; color: ${mostPoints.color};">
                                ${mostPoints.colorName} (${mostPoints.pointsFor})
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Best Point Diff</div>
                            <div class="metric-value" style="font-size: 18px; color: ${bestDiff.color};">
                                ${bestDiff.colorName} (+${bestDiff.pointDiff})
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Highest Scoring Match</div>
                            <div class="metric-value" style="font-size: 16px;">
                                ${highestScoringMatch.team1} vs ${highestScoringMatch.team2}<br>
                                <span style="font-size: 20px;">${highestScoringMatch.score1 + highestScoringMatch.score2} pts</span>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-label">Teams Participated</div>
                            <div class="metric-value">${teams.length}</div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="minimize-btn" onclick="minimizeAllAndShowSummary()">
                            ‚ñ≤ Minimize All Sections
                        </button>
                    </div>
                </div>
            `;
        }

        function minimizeAllAndShowSummary() {
            // Minimize setup
            if (setupComplete) {
                document.getElementById('setupContent').classList.add('hidden');
                document.getElementById('chevron').textContent = '‚ñº';
                setupMinimized = true;
            }

            // Scroll to summary
            document.getElementById('tournamentSummarySection').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            // Add collapsible functionality to all cards
            const cards = ['completedMatchesCard'];
            cards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card && !card.dataset.collapsible) {
                    card.dataset.collapsible = 'true';
                    const header = card.querySelector('h2');
                    header.style.cursor = 'pointer';
                    header.innerHTML += ' <span style="float: right;">‚ñº</span>';
                    
                    header.onclick = function() {
                        const content = card.querySelector('div');
                        const chevron = header.querySelector('span');
                        if (content.style.display === 'none') {
                            content.style.display = 'block';
                            chevron.textContent = '‚ñº';
                        } else {
                            content.style.display = 'none';
                            chevron.textContent = '‚ñ∂';
                        }
                    };
                }
            });
        }

        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Hide remaining matches when team selection changes
        document.addEventListener('DOMContentLoaded', function() {
            const remainingSelect = document.getElementById('remainingTeamSelect');
            if (remainingSelect) {
                remainingSelect.addEventListener('change', function() {
                    document.getElementById('remainingMatchesBox').classList.add('hidden');
                });
            }
        });
    </script>
    
</body>
</html>
