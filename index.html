<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∏ ShuttleSquad Doubles Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 32px;
            margin: 10px 0;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .card-header h2 {
            font-size: 20px;
            color: #1F2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-content {
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background: #3B82F6;
            color: white;
            width: 100%;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
            width: 100%;
        }
        
        .btn-purple {
            background: #8B5CF6;
            color: white;
        }
        
        .btn-gray {
            background: #6B7280;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: #FEE2E2;
            color: #991B1B;
            padding: 6px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* DOUBLES INPUT STYLING */
        .team-input-group {
            background: #F9FAFB;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 5px solid #ccc; /* Will be colored via JS */
        }

        .player-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .error {
            margin-top: 16px;
            padding: 12px;
            background: #FEE2E2;
            border: 1px solid #EF4444;
            border-radius: 8px;
            color: #991B1B;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead tr {
            background: #F3F4F6;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
        }
        
        th {
            font-weight: 600;
            color: #374151;
        }
        
        tbody tr {
            border-bottom: 1px solid #E5E7EB;
        }
        
        /* RESPONSIVE MATCH DISPLAY */
        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            margin-bottom: 10px;
        }
        
        .match-vs {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin: 12px 0;
            font-size: 16px; /* Slightly smaller base font */
            font-weight: 600;
        }

        .team-name-box {
            flex: 1;
            min-width: 0;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
            padding: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* Style specifically for the pair of names */
        .pair-names {
            font-size: 1em;
            color: #1F2937;
        }

        .score-box {
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 1.2em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .vs-text {
            color: #9CA3AF;
            font-size: 0.8em;
            flex-shrink: 0;
            font-weight: 400;
        }

        .match-result {
            background: #F0FDF4;
            border: 2px solid #10B981;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .match-result.final {
            background: #FEF3C7;
            border-color: #F59E0B;
        }

        .match-result.third-place {
            background: #FCE7F3;
            border-color: #EC4899;
        }

        .playoff-match {
            background: #F9FAFB;
            border: 2px solid #E5E7EB;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .minimize-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .minimize-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .player-inputs {
                grid-template-columns: 1fr; /* Stack inputs on small mobile */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∏ ShuttleSquad üè∏</h1>
            <p style="opacity: 0.8; font-size: 14px;">Doubles Tournament Tracker</p>
            <button id="resetBtn" class="btn-gray hidden" style="margin-top: 10px;" onclick="resetTournament()">Reset Tournament</button>
        </div>

        <div class="card">
            <div class="card-header" id="setupHeader">
                <h2>
                    <span>üë•</span>
                    <span id="setupTitle">Team Setup</span>
                </h2>
                <span id="chevron">‚ñº</span>
            </div>
            <div class="card-content" id="setupContent">
                <div id="numTeamsSection">
                    <label>How many teams are playing?</label>
                    <input type="number" id="numTeams" min="2" max="12" placeholder="Enter number (2-12)">
                    <button class="btn-primary" onclick="createTeamInputs()">Continue</button>
                </div>
                <div id="teamInputsSection" class="hidden"></div>
                <div id="setupError" class="error hidden"></div>
            </div>
        </div>

        <div id="tournamentSection" class="hidden">
            <div class="grid-2">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Add Match Result</h2>
                    <label>Team 1</label>
                    <select id="team1Select">
                        <option value="">Select team</option>
                    </select>
                    <label>Score 1</label>
                    <input type="number" id="score1" min="0" placeholder="0">
                    <label>Team 2</label>
                    <select id="team2Select">
                        <option value="">Select team</option>
                    </select>
                    <label>Score 2</label>
                    <input type="number" id="score2" min="0" placeholder="0">
                    <button class="btn-primary" onclick="addMatch()">Add Match Result</button>
                    <div id="matchError" class="error hidden"></div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 16px;">Leaderboard</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Team Pair</th>
                                    <th class="text-center">Plyd</th>
                                    <th class="text-center">W</th>
                                    <th class="text-center">L</th>
                                    <th class="text-center">+/-</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

              <div class="card">
                <h2 style="margin-bottom: 16px;">Check Remaining Matches</h2>
                <div class="flex-row" style="display:flex; gap:10px; align-items:flex-end;">
                    <div class="flex-1" style="flex:1;">
                        <label>Select Team</label>
                        <select id="remainingTeamSelect">
                            <option value="">Choose a team</option>
                        </select>
                    </div>
                    <button class="btn-purple" onclick="showRemainingMatches()">Show</button>
                </div>
                <div id="remainingMatchesBox" class="hidden"></div>
            </div>

              <div class="card" id="completedMatchesCard">
                <div class="card-header" style="cursor: pointer;" onclick="toggleCompletedMatches()">
                    <h2>Completed Matches (<span id="matchCount">0</span>)</h2>
                    <span id="completedChevron">‚ñº</span>
                </div>
                <div class="card-content" id="matchesList"></div>
            </div>

            <div class="card" id="playoffCard">
                <div class="card-header" id="playoffHeader" style="cursor: pointer;" onclick="togglePlayoff()">
                    <h2>üèÜ Playoff Matches</h2>
                    <span id="playoffChevron">‚ñº</span>
                </div>
                <div class="card-content" id="semifinalContent"></div>
            </div>

            <div class="card" id="tournamentSummaryCard" class="hidden">
                <h2 style="margin-bottom: 16px;">üèÜ Tournament Results</h2>
                <div id="tournamentSummaryContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Colors are kept ONLY for visual styling (borders), not for ID logic
        const TEAM_COLORS = [
            '#EF4444', '#3B82F6', '#10B981', '#F59E0B', 
            '#8B5CF6', '#EC4899', '#14B8A6', '#F97316',
            '#06b6d4', '#6366f1', '#65a30d', '#78350f'
        ];
        
        let teams = [];
        let matches = [];
        let setupComplete = false;
        let setupMinimized = false;
        let semifinal1 = null;
        let semifinal2 = null;
        let finalMatch = null;
        let thirdPlaceMatch = null;
        let playoffMinimized = false;
        let completedMatchesMinimized = false;

        window.onload = function() {
            const savedTeams = JSON.parse(localStorage.getItem('teams') || '[]');
            const savedMatches = JSON.parse(localStorage.getItem('matches') || '[]');
            const savedSemifinal1 = JSON.parse(localStorage.getItem('semifinal1') || 'null');
            const savedSemifinal2 = JSON.parse(localStorage.getItem('semifinal2') || 'null');
            const savedFinal = JSON.parse(localStorage.getItem('finalMatch') || 'null');
            const savedThirdPlace = JSON.parse(localStorage.getItem('thirdPlaceMatch') || 'null');
            
            if (savedTeams.length > 0) {
                teams = savedTeams;
                matches = savedMatches;
                semifinal1 = savedSemifinal1;
                semifinal2 = savedSemifinal2;
                finalMatch = savedFinal;
                thirdPlaceMatch = savedThirdPlace;
                setupComplete = true;
                setupMinimized = true;
                showTournament();
            }
        };

        function createTeamInputs() {
            const num = parseInt(document.getElementById('numTeams').value);
            if (num < 2 || num > 12) {
                showError('setupError', 'Please enter between 2 and 12 teams');
                return;
            }

            teams = Array.from({ length: num }, (_, i) => ({
                id: i, // Numeric ID 0, 1, 2...
                color: TEAM_COLORS[i],
                p1: '',
                p2: '',
                displayName: ''
            }));

            document.getElementById('numTeamsSection').classList.add('hidden');
            const section = document.getElementById('teamInputsSection');
            section.classList.remove('hidden');
            
            let html = '<h3 style="font-size: 16px; margin-bottom: 16px; color: #374151;">Enter Team Players (Doubles)</h3>';
            teams.forEach((team, idx) => {
                html += `
                    <div class="team-input-group" style="border-left-color: ${team.color}">
                        <label style="color: ${team.color}; margin-bottom: 8px;">Team ${idx + 1}</label>
                        <div class="player-inputs">
                            <input type="text" id="p1_${team.id}" placeholder="Player 1 Name" maxlength="12" style="margin-bottom:0">
                            <input type="text" id="p2_${team.id}" placeholder="Player 2 Name" maxlength="12" style="margin-bottom:0">
                        </div>
                    </div>
                `;
            });
            html += '<button class="btn-success" onclick="saveTeams()">Save & Start Tournament</button>';
            section.innerHTML = html;
            hideError('setupError');
        }

        function saveTeams() {
            let allFilled = true;
            teams.forEach(team => {
                const p1 = document.getElementById(`p1_${team.id}`).value.trim();
                const p2 = document.getElementById(`p2_${team.id}`).value.trim();
                
                if (!p1 || !p2) {
                    allFilled = false;
                } else {
                    team.p1 = p1;
                    team.p2 = p2;
                    team.displayName = `${p1} / ${p2}`;
                }
            });

            if (!allFilled) {
                showError('setupError', 'Please fill in ALL player names.');
                return;
            }

            localStorage.setItem('teams', JSON.stringify(teams));
            localStorage.setItem('matches', JSON.stringify([]));
            matches = [];
            setupComplete = true;
            setupMinimized = true;
            showTournament();
        }

        function showTournament() {
            document.getElementById('setupTitle').textContent = 'Team Setup (Complete)';
            document.getElementById('setupContent').classList.add('hidden');
            document.getElementById('chevron').textContent = '‚ñº';
            document.getElementById('tournamentSection').classList.remove('hidden');
            document.getElementById('resetBtn').classList.remove('hidden');
            
            document.getElementById('setupHeader').onclick = toggleSetup;
            
            populateDropdowns();
            updateLeaderboard();
            updateMatchesList();
            updatePlayoffSection();
            updateTournamentSummary();
        }

        function toggleSetup() {
            if (!setupComplete) return;
            setupMinimized = !setupMinimized;
            const content = document.getElementById('setupContent');
            const chevron = document.getElementById('chevron');
            
            if (setupMinimized) {
                content.classList.add('hidden');
                chevron.textContent = '‚ñº';
            } else {
                content.classList.remove('hidden');
                chevron.textContent = '‚ñ≤';
            }
        }

        function populateDropdowns() {
            const selects = ['team1Select', 'team2Select', 'remainingTeamSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const options = teams.map(t => 
                    `<option value="${t.id}">${t.displayName}</option>`
                ).join('');
                select.innerHTML = `<option value="">${selectId === 'remainingTeamSelect' ? 'Choose a team' : 'Select team'}</option>${options}`;
            });
        }

        function addMatch() {
            const team1Id = document.getElementById('team1Select').value;
            const team2Id = document.getElementById('team2Select').value;
            const score1 = parseInt(document.getElementById('score1').value);
            const score2 = parseInt(document.getElementById('score2').value);

            if (!team1Id || !team2Id) {
                showError('matchError', 'Please select both teams');
                return;
            }

            if (team1Id === team2Id) {
                showError('matchError', 'Teams must be different');
                return;
            }

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showError('matchError', 'Please enter valid scores');
                return;
            }

            if (score1 === score2) {
                showError('matchError', 'Ties are not allowed. Please play until a winner is decided.');
                return;
            }

            // Convert string IDs from select to numbers
            const t1 = parseInt(team1Id);
            const t2 = parseInt(team2Id);

            const matchExists = matches.some(m => 
                (m.team1Id === t1 && m.team2Id === t2) ||
                (m.team1Id === t2 && m.team2Id === t1)
            );

            if (matchExists) {
                showError('matchError', 'Match between these teams already recorded');
                return;
            }

            matches.push({
                id: Date.now(),
                team1Id: t1,
                team2Id: t2,
                score1,
                score2
            });

            localStorage.setItem('matches', JSON.stringify(matches));
            
            // Clear inputs
            document.getElementById('team1Select').value = '';
            document.getElementById('team2Select').value = '';
            document.getElementById('score1').value = '';
            document.getElementById('score2').value = '';
            
            hideError('matchError');
            updateLeaderboard();
            updateMatchesList();
            updatePlayoffSection();
            updateTournamentSummary();
        }

        function cancelMatch(matchId) {
            matches = matches.filter(m => m.id !== matchId);
            localStorage.setItem('matches', JSON.stringify(matches));
            updateLeaderboard();
            updateMatchesList();
        }

        function getLeaderboardData() {
            const stats = teams.map(team => ({
                ...team,
                played: 0,
                wins: 0,
                losses: 0,
                pointsFor: 0,
                pointsAgainst: 0
            }));

            matches.forEach(match => {
                const team1Stats = stats.find(s => s.id === match.team1Id);
                const team2Stats = stats.find(s => s.id === match.team2Id);

                if (team1Stats && team2Stats) {
                    team1Stats.played++;
                    team2Stats.played++;
                    team1Stats.pointsFor += match.score1;
                    team1Stats.pointsAgainst += match.score2;
                    team2Stats.pointsFor += match.score2;
                    team2Stats.pointsAgainst += match.score1;

                    if (match.score1 > match.score2) {
                        team1Stats.wins++;
                        team2Stats.losses++;
                    } else {
                        team2Stats.wins++;
                        team1Stats.losses++;
                    }
                }
            });

            return stats
                .map(s => ({
                    ...s,
                    pointDiff: s.pointsFor - s.pointsAgainst
                }))
                .sort((a, b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    return b.pointDiff - a.pointDiff;
                });
        }

        function updateLeaderboard() {
            const leaderboard = getLeaderboardData();
            const tbody = document.getElementById('leaderboardBody');
            
            tbody.innerHTML = leaderboard.map(team => `
                <tr>
                    <td>
                        <div style="font-weight: 600; font-size: 14px; border-left: 3px solid ${team.color}; padding-left: 8px;">
                            ${team.p1} / ${team.p2}
                        </div>
                    </td>
                    <td class="text-center">${team.played}</td>
                    <td class="text-center" style="font-weight: 600; color: #10B981;">${team.wins}</td>
                    <td class="text-center" style="font-weight: 600; color: #EF4444;">${team.losses}</td>
                    <td class="text-center" style="font-weight: 600; color: ${team.pointDiff >= 0 ? '#10B981' : '#EF4444'};">
                        ${team.pointDiff >= 0 ? '+' : ''}${team.pointDiff}
                    </td>
                </tr>
            `).join('');
        }

        function updateMatchesList() {
            document.getElementById('matchCount').textContent = matches.length;
            const list = document.getElementById('matchesList');
            
            if (matches.length === 0) {
                list.innerHTML = '<div class="no-matches">No matches recorded yet</div>';
                return;
            }

            list.innerHTML = matches.map(match => {
                const t1 = teams.find(t => t.id === match.team1Id);
                const t2 = teams.find(t => t.id === match.team2Id);
                
                // Safety check
                if (!t1 || !t2) return '';

                const isWinner1 = match.score1 > match.score2;
                
                return `
                    <div class="match-item">
                        <div class="match-vs" style="width: 100%; margin: 0;">
                            <div class="team-name-box" style="text-align: right;">
                                <div style="color: ${isWinner1 ? t1.color : '#6B7280'}; font-weight: ${isWinner1 ? 'bold' : 'normal'}">
                                    ${t1.displayName}
                                </div>
                            </div>
                            <div class="score-box" style="font-size: 14px; padding: 2px 8px;">${match.score1}</div>
                            <div class="vs-text">-</div>
                            <div class="score-box" style="font-size: 14px; padding: 2px 8px;">${match.score2}</div>
                            <div class="team-name-box" style="text-align: left;">
                                <div style="color: ${!isWinner1 ? t2.color : '#6B7280'}; font-weight: ${!isWinner1 ? 'bold' : 'normal'}">
                                    ${t2.displayName}
                                </div>
                            </div>
                        </div>
                        <button class="btn-danger" style="margin-left: 10px;" onclick="cancelMatch(${match.id})" title="Cancel match">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function showRemainingMatches() {
            const selectedTeamId = parseInt(document.getElementById('remainingTeamSelect').value);
            if (isNaN(selectedTeamId)) {
                alert('Please select a team');
                return;
            }

            const playedAgainstIds = matches
                .filter(m => m.team1Id === selectedTeamId || m.team2Id === selectedTeamId)
                .map(m => m.team1Id === selectedTeamId ? m.team2Id : m.team1Id);

            const remaining = teams
                .filter(t => t.id !== selectedTeamId && !playedAgainstIds.includes(t.id));

            const box = document.getElementById('remainingMatchesBox');
            box.classList.remove('hidden');

            const selectedTeamName = teams.find(t => t.id === selectedTeamId)?.displayName;

            if (remaining.length === 0) {
                box.innerHTML = `
                    <div class="remaining-box">
                        <h3 style="font-size: 14px; margin-bottom: 8px;">
                            ${selectedTeamName} needs to play against:
                        </h3>
                        <p style="color: #10B981; font-weight: 600;">‚úì All matches completed!</p>
                    </div>
                `;
            } else {
                const list = remaining.map(team => 
                    `<li style="margin-bottom: 4px; border-left: 3px solid ${team.color}; padding-left: 8px;">
                        ${team.displayName}
                    </li>`
                ).join('');
                
                box.innerHTML = `
                    <div class="remaining-box">
                        <h3 style="font-size: 14px; margin-bottom: 8px;">
                            ${selectedTeamName} needs to play against:
                        </h3>
                        <ul style="margin: 0; padding-left: 20px;">${list}</ul>
                    </div>
                `;
            }
        }

        function renderMatchResult(match, extraClass, title) {
            const t1 = teams.find(t => t.id === match.team1Id);
            const t2 = teams.find(t => t.id === match.team2Id);
            // Handling manual entry or object storage
            const t1Name = t1 ? t1.displayName : "Team 1";
            const t2Name = t2 ? t2.displayName : "Team 2";
            const t1Color = t1 ? t1.color : '#333';
            const t2Color = t2 ? t2.color : '#333';

            const winnerName = match.score1 > match.score2 ? t1Name : t2Name;
            const winnerColor = match.score1 > match.score2 ? t1Color : t2Color;
            const isWinner1 = match.score1 > match.score2;
            
            return `
                <div class="match-result ${extraClass}">
                    <h3 style="margin-bottom: 12px; font-size: 16px;">${title}</h3>
                    <div class="match-vs">
                        <div class="team-name-box">
                            <div class="pair-names" style="color: ${t1Color}; font-weight: bold; ${isWinner1 ? 'font-size: 1.1em;' : ''}">
                                ${t1Name}
                            </div>
                        </div>
                        
                        <div class="score-box">${match.score1}</div>
                        <div class="vs-text">vs</div>
                        <div class="score-box">${match.score2}</div>
                        
                        <div class="team-name-box">
                            <div class="pair-names" style="color: ${t2Color}; font-weight: bold; ${!isWinner1 ? 'font-size: 1.1em;' : ''}">
                                ${t2Name}
                            </div>
                        </div>
                    </div>
                    <p style="text-align: center; margin-top: 8px; color: ${winnerColor}; font-weight: 600; font-size: 0.9em;">
                        üèÜ Winner: ${winnerName}
                    </p>
                </div>
            `;
        }

        function renderSemifinalInput(matchId, title, team1, team2) {
            return `
                <div class="playoff-match">
                    <h3>‚öîÔ∏è ${title}</h3>
                    <div class="match-vs">
                        <div class="team-name-box">
                            <div style="color: ${team1.color}; font-weight: bold;">${team1.displayName}</div>
                        </div>
                        <span class="vs-text">vs</span>
                        <div class="team-name-box">
                            <div style="color: ${team2.color}; font-weight: bold;">${team2.displayName}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score Top Seed</label>
                            <input type="number" id="${matchId}_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score Low Seed</label>
                            <input type="number" id="${matchId}_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top: 12px;" onclick="saveSemifinal('${matchId}', ${team1.id}, ${team2.id})">
                        Save Result
                    </button>
                </div>
            `;
        }

        function renderSemifinalInputManual(matchId, title) {
            return `
                <div class="playoff-match">
                    <h3>‚öîÔ∏è ${title}</h3>
                    <p style="color: #6B7280; font-size: 14px; margin-bottom: 12px;">
                        Tied positions detected. Please select teams manually.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label>Team 1</label>
                            <select id="${matchId}_team1" style="margin-bottom: 0;">
                                <option value="">Select team</option>
                                ${teams.map(t => `<option value="${t.id}">${t.displayName}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label>Team 2</label>
                            <select id="${matchId}_team2" style="margin-bottom: 0;">
                                <option value="">Select team</option>
                                ${teams.map(t => `<option value="${t.id}">${t.displayName}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score 1</label>
                            <input type="number" id="${matchId}_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score 2</label>
                            <input type="number" id="${matchId}_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top: 12px;" onclick="saveSemifinalManual('${matchId}')">
                        Save Result
                    </button>
                </div>
            `;
        }

        function renderFinalInput(winner1Id, winner2Id, loser1Id, loser2Id) {
            const w1Team = teams.find(t => t.id === winner1Id);
            const w2Team = teams.find(t => t.id === winner2Id);
            const l1Team = teams.find(t => t.id === loser1Id);
            const l2Team = teams.find(t => t.id === loser2Id);
            
            return `
                <div class="playoff-match" style="border-color: #F59E0B; margin-bottom: 16px;">
                    <h3>üèÜ Final Match</h3>
                    <div class="match-vs">
                        <div class="team-name-box">
                            <div style="color: ${w1Team?.color}; font-weight: bold;">${w1Team?.displayName}</div>
                        </div>
                        <span class="vs-text">vs</span>
                        <div class="team-name-box">
                            <div style="color: ${w2Team?.color}; font-weight: bold;">${w2Team?.displayName}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score ${w1Team?.p1.split(' ')[0]}</label>
                            <input type="number" id="final_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score ${w2Team?.p1.split(' ')[0]}</label>
                            <input type="number" id="final_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                </div>
                <div class="playoff-match" style="border-color: #EC4899;">
                    <h3>ü•â Third Place Match</h3>
                    <div class="match-vs">
                        <div class="team-name-box">
                            <div style="color: ${l1Team?.color}; font-weight: bold;">${l1Team?.displayName}</div>
                        </div>
                        <span class="vs-text">vs</span>
                        <div class="team-name-box">
                            <div style="color: ${l2Team?.color}; font-weight: bold;">${l2Team?.displayName}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label>Score ${l1Team?.p1.split(' ')[0]}</label>
                            <input type="number" id="third_score1" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label>Score ${l2Team?.p1.split(' ')[0]}</label>
                            <input type="number" id="third_score2" min="0" placeholder="0" style="margin-bottom: 0;">
                        </div>
                    </div>
                </div>
                <button class="btn-success" style="margin-top: 12px; background: #10B981; width: 100%;" onclick="saveBothFinalMatches(${winner1Id}, ${winner2Id}, ${loser1Id}, ${loser2Id})">
                    üíæ Save All Final Results
                </button>
            `;
        }

        // Logic Functions for Semifinals/Finals
        function updatePlayoffSection() {
            const content = document.getElementById('semifinalContent');
            
            if (teams.length < 4) {
                content.innerHTML = '<p class="no-matches">Need at least 4 teams for playoffs</p>';
                return;
            }

            const leaderboard = getLeaderboardData();
            const top4 = leaderboard.slice(0, 4);
            
            // Check clear seeding
            const hasClearTop4 = leaderboard.length === 4 || 
                (leaderboard.length > 4 && 
                 (top4[3].wins !== leaderboard[4].wins || 
                  (top4[3].wins === leaderboard[4].wins && top4[3].pointDiff !== leaderboard[4].pointDiff)));

            let html = '';

            if (finalMatch) {
                html += renderMatchResult(finalMatch, 'final', 'üèÜ Final Match');
            }
            if (thirdPlaceMatch) {
                html += renderMatchResult(thirdPlaceMatch, 'third-place', 'ü•â Third Place Match');
            }

            // Semi 1: 1st vs 4th
            if (semifinal1) {
                html += renderMatchResult(semifinal1, '', '‚öîÔ∏è Semifinal Match 1 (1st vs 4th)');
            } else if (hasClearTop4) {
                html += renderSemifinalInput('semifinal1', 'Semifinal Match 1 (1st vs 4th)', top4[0], top4[3]);
            } else {
                html += renderSemifinalInputManual('semifinal1', 'Semifinal Match 1');
            }

            // Semi 2: 2nd vs 3rd
            if (semifinal2) {
                html += renderMatchResult(semifinal2, '', '‚öîÔ∏è Semifinal Match 2 (2nd vs 3rd)');
            } else if (hasClearTop4) {
                html += renderSemifinalInput('semifinal2', 'Semifinal Match 2 (2nd vs 3rd)', top4[1], top4[2]);
            } else {
                html += renderSemifinalInputManual('semifinal2', 'Semifinal Match 2');
            }

            // Show final input logic
            if (semifinal1 && semifinal2 && !finalMatch && !thirdPlaceMatch) {
                const sf1WinnerId = semifinal1.score1 > semifinal1.score2 ? semifinal1.team1Id : semifinal1.team2Id;
                const sf1LoserId = semifinal1.score1 > semifinal1.score2 ? semifinal1.team2Id : semifinal1.team1Id;
                
                const sf2WinnerId = semifinal2.score1 > semifinal2.score2 ? semifinal2.team1Id : semifinal2.team2Id;
                const sf2LoserId = semifinal2.score1 > semifinal2.score2 ? semifinal2.team2Id : semifinal2.team1Id;
                
                html += renderFinalInput(sf1WinnerId, sf2WinnerId, sf1LoserId, sf2LoserId);
            }

            content.innerHTML = html || '<p class="no-matches">Complete round robin matches to start playoffs</p>';
        }

        function saveSemifinal(matchId, t1Id, t2Id) {
            const score1 = parseInt(document.getElementById(`${matchId}_score1`).value);
            const score2 = parseInt(document.getElementById(`${matchId}_score2`).value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                alert('Please enter valid scores');
                return;
            }
            if (score1 === score2) {
                alert('Scores cannot be tied in playoffs');
                return;
            }

            const match = { team1Id: t1Id, team2Id: t2Id, score1, score2 };

            if (matchId === 'semifinal1') {
                semifinal1 = match;
                localStorage.setItem('semifinal1', JSON.stringify(match));
            } else {
                semifinal2 = match;
                localStorage.setItem('semifinal2', JSON.stringify(match));
            }
            updatePlayoffSection();
        }

        function saveSemifinalManual(matchId) {
            const t1Id = parseInt(document.getElementById(`${matchId}_team1`).value);
            const t2Id = parseInt(document.getElementById(`${matchId}_team2`).value);
            const score1 = parseInt(document.getElementById(`${matchId}_score1`).value);
            const score2 = parseInt(document.getElementById(`${matchId}_score2`).value);

            if (isNaN(t1Id) || isNaN(t2Id)) { alert("Select teams"); return; }
            if (t1Id === t2Id) { alert("Same team selected"); return; }
            if (isNaN(score1) || isNaN(score2)) { alert("Invalid score"); return; }
            if (score1 === score2) { alert("No ties allowed"); return; }

            const match = { team1Id: t1Id, team2Id: t2Id, score1, score2 };
            
            if (matchId === 'semifinal1') {
                semifinal1 = match;
                localStorage.setItem('semifinal1', JSON.stringify(match));
            } else {
                semifinal2 = match;
                localStorage.setItem('semifinal2', JSON.stringify(match));
            }
            updatePlayoffSection();
        }

        function saveBothFinalMatches(w1Id, w2Id, l1Id, l2Id) {
            const fs1 = parseInt(document.getElementById('final_score1').value);
            const fs2 = parseInt(document.getElementById('final_score2').value);
            const ts1 = parseInt(document.getElementById('third_score1').value);
            const ts2 = parseInt(document.getElementById('third_score2').value);

            if (isNaN(fs1) || isNaN(fs2) || isNaN(ts1) || isNaN(ts2)) {
                alert('Please fill all scores'); return;
            }
            if (fs1 === fs2 || ts1 === ts2) {
                alert('No ties allowed in finals'); return;
            }

            finalMatch = { team1Id: w1Id, team2Id: w2Id, score1: fs1, score2: fs2 };
            thirdPlaceMatch = { team1Id: l1Id, team2Id: l2Id, score1: ts1, score2: ts2 };

            localStorage.setItem('finalMatch', JSON.stringify(finalMatch));
            localStorage.setItem('thirdPlaceMatch', JSON.stringify(thirdPlaceMatch));

            updatePlayoffSection();
            updateTournamentSummary();
        }

        function updateTournamentSummary() {
            const summaryCard = document.getElementById('tournamentSummaryCard');
            const summaryContent = document.getElementById('tournamentSummaryContent');
            
            if (!finalMatch || !thirdPlaceMatch) {
                summaryCard.classList.add('hidden');
                return;
            }

            summaryCard.classList.remove('hidden');

            const championId = finalMatch.score1 > finalMatch.score2 ? finalMatch.team1Id : finalMatch.team2Id;
            const runnerUpId = finalMatch.score1 > finalMatch.score2 ? finalMatch.team2Id : finalMatch.team1Id;
            const thirdPlaceId = thirdPlaceMatch.score1 > thirdPlaceMatch.score2 ? thirdPlaceMatch.team1Id : thirdPlaceMatch.team2Id;

            const champ = teams.find(t => t.id === championId);
            const runner = teams.find(t => t.id === runnerUpId);
            const third = teams.find(t => t.id === thirdPlaceId);

            summaryContent.innerHTML = `
                <div style="background: linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 40px;">ü•á</div>
                        <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">${champ ? champ.displayName : ''}</div>
                        <div style="opacity: 0.8; font-size: 14px;">CHAMPIONS</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 30px;">ü•à</div>
                            <div style="font-size: 16px; font-weight: bold;">${runner ? runner.displayName : ''}</div>
                            <div style="font-size: 12px; opacity: 0.8;">Runner Up</div>
                        </div>
                        <div>
                            <div style="font-size: 30px;">ü•â</div>
                            <div style="font-size: 16px; font-weight: bold;">${third ? third.displayName : ''}</div>
                            <div style="font-size: 12px; opacity: 0.8;">3rd Place</div>
                        </div>
                    </div>
                    
                    <button class="minimize-btn" onclick="minimizeAllSections()">Minimize All</button>
                    <button class="minimize-btn" style="background:#10B981; border:none; margin-left:10px;" onclick="downloadCSV()">CSV</button>
                </div>
            `;
        }
        
        function minimizeAllSections() {
            document.getElementById('matchesList').classList.add('hidden');
            document.getElementById('semifinalContent').classList.add('hidden');
            document.getElementById('setupContent').classList.add('hidden');
            document.getElementById('tournamentSummaryCard').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadCSV() {
            const rows = [['Match Type', 'Team 1', 'Score 1', 'Score 2', 'Team 2', 'Winner']];
            
            matches.forEach(m => {
                const t1 = teams.find(t => t.id === m.team1Id);
                const t2 = teams.find(t => t.id === m.team2Id);
                const winner = m.score1 > m.score2 ? t1.displayName : t2.displayName;
                rows.push(['League', t1.displayName, m.score1, m.score2, t2.displayName, winner]);
            });

            if(semifinal1) {
                const t1 = teams.find(t => t.id === semifinal1.team1Id);
                const t2 = teams.find(t => t.id === semifinal1.team2Id);
                const w = semifinal1.score1 > semifinal1.score2 ? t1.displayName : t2.displayName;
                rows.push(['Semi 1', t1.displayName, semifinal1.score1, semifinal1.score2, t2.displayName, w]);
            }
             if(semifinal2) {
                const t1 = teams.find(t => t.id === semifinal2.team1Id);
                const t2 = teams.find(t => t.id === semifinal2.team2Id);
                const w = semifinal2.score1 > semifinal2.score2 ? t1.displayName : t2.displayName;
                rows.push(['Semi 2', t1.displayName, semifinal2.score1, semifinal2.score2, t2.displayName, w]);
            }
             if(finalMatch) {
                const t1 = teams.find(t => t.id === finalMatch.team1Id);
                const t2 = teams.find(t => t.id === finalMatch.team2Id);
                const w = finalMatch.score1 > finalMatch.score2 ? t1.displayName : t2.displayName;
                rows.push(['Final', t1.displayName, finalMatch.score1, finalMatch.score2, t2.displayName, w]);
            }

            let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "tournament_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetTournament() {
            if(confirm("Reset everything?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function showError(id, msg) {
            document.getElementById(id).textContent = msg;
            document.getElementById(id).classList.remove('hidden');
        }
        function hideError(id) {
            document.getElementById(id).classList.add('hidden');
        }
        function toggleCompletedMatches() {
            completedMatchesMinimized = !completedMatchesMinimized;
            const content = document.getElementById('matchesList');
            const chevron = document.getElementById('completedChevron');
            if (completedMatchesMinimized) { content.classList.add('hidden'); chevron.textContent = '‚ñ∂'; } 
            else { content.classList.remove('hidden'); chevron.textContent = '‚ñº'; }
        }
        function togglePlayoff() {
            playoffMinimized = !playoffMinimized;
            const content = document.getElementById('semifinalContent');
            const chevron = document.getElementById('playoffChevron');
            if (playoffMinimized) { content.classList.add('hidden'); chevron.textContent = '‚ñ∂'; } 
            else { content.classList.remove('hidden'); chevron.textContent = '‚ñº'; }
        }
        
        // Listener for team select logic in remaining matches
        document.getElementById('remainingTeamSelect').addEventListener('change', () => {
             document.getElementById('remainingMatchesBox').classList.add('hidden');
        });
    </script>
</body>
</html>
